library(DBI)
library(dplyr)
library(googlesheets4)

con2 <- dbConnect(odbc::odbc(), "reproreplica", timeout = 10)

result <- dbGetQuery(con2,"

WITH FIS AS (SELECT FISCODIGO FROM TBFIS WHERE FISTPNATOP IN ('V','R','SR')),

SETOR AS (SELECT ZOCODIGO,ZODESCRICAO FROM ZONA WHERE ZOCODIGO IN (20,21,22,23,24,25,26,27,28)),

ENDE AS (SELECT ENDCODIGO,CLICODIGO,ZODESCRICAO,ED.ZOCODIGO FROM ENDCLI ED

INNER JOIN SETOR ON ED.ZOCODIGO=SETOR.ZOCODIGO WHERE ENDFAT='S'),

PEDEMIS AS (SELECT ID_PEDIDO,PEDDTEMIS,PEDID.CLICODIGO,ZODESCRICAO,ZOCODIGO FROM PEDID 
INNER JOIN FIS ON PEDID.FISCODIGO1=FIS.FISCODIGO
 INNER JOIN ENDE ON PEDID.CLICODIGO=ENDE.CLICODIGO AND PEDID.ENDCODIGO=ENDE.ENDCODIGO
  WHERE (PEDDTEMIS BETWEEN (CURRENT_DATE) - EXTRACT(DAY FROM (CURRENT_DATE)) + 1 AND 'TODAY' OR
  PEDDTEMIS BETWEEN DATEADD(-1 YEAR TO (CURRENT_DATE) - EXTRACT(DAY FROM CURRENT_DATE) + 1)
AND DATEADD(-1 YEAR TO (CURRENT_DATE) - EXTRACT(DAY FROM CURRENT_DATE) + 32 - 
EXTRACT(DAY FROM (CURRENT_DATE) - EXTRACT(DAY FROM (CURRENT_DATE)) + 32)))  
AND PEDSITPED<>'C' AND PEDLCFINANC IN ('S', 'L','N')),

PEDBAIXA AS (SELECT ID_PEDIDO,PEDDTBAIXA,PEDID.CLICODIGO,ZODESCRICAO,ZOCODIGO FROM PEDID 
 INNER JOIN FIS ON PEDID.FISCODIGO1=FIS.FISCODIGO
  INNER JOIN ENDE ON PEDID.CLICODIGO=ENDE.CLICODIGO AND PEDID.ENDCODIGO=ENDE.ENDCODIGO
   WHERE (PEDDTBAIXA BETWEEN (CURRENT_DATE) - EXTRACT(DAY FROM CURRENT_DATE) + 1 AND 'TODAY' OR
   PEDDTBAIXA BETWEEN DATEADD(-1 YEAR TO (CURRENT_DATE) - EXTRACT(DAY FROM CURRENT_DATE) + 1)
AND DATEADD(-1 YEAR TO (CURRENT_DATE) - EXTRACT(DAY FROM CURRENT_DATE) + 32 - 
EXTRACT(DAY FROM (CURRENT_DATE) - EXTRACT(DAY FROM CURRENT_DATE) + 32)))
   AND PEDSITPED<>'C' AND PEDLCFINANC IN ('S', 'L','N'))

SELECT TRIM('EMISSAO') TIPO,CAST(PEDDTEMIS AS DATE) DATA,ZODESCRICAO,ZOCODIGO, SUM(PDPUNITLIQUIDO*PDPQTDADE)VRVENDA 
 FROM PDPRD PD
  INNER JOIN PEDEMIS PE ON PD.ID_PEDIDO=PE.ID_PEDIDO
  GROUP BY 1,2,3,4 UNION
SELECT TRIM('BAIXA') TIPO,CAST(PEDDTBAIXA AS DATE) DATA,ZODESCRICAO,ZOCODIGO, SUM(PDPUNITLIQUIDO*PDPQTDADE)VRVENDA 
 FROM PDPRD PD
  INNER JOIN PEDBAIXA PB ON PD.ID_PEDIDO=PB.ID_PEDIDO
  GROUP BY 1,2,3,4


")


sheet_write(result,ss="1bcAoyy0DUBzNuYcyGmZTCyZ2uGqPpgW7kXBmOOxlmhM",sheet="DADOS")

